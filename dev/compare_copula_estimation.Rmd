---
title: "compare_marginal_fitting"
output: html_document
---

```{r}
library(ggplot2)
library(tidyverse)
library(goftest)
library(purrr)

copula_comparison_file <- "output/copula_estimation_comparison.rds"
copula_comparisons <- readRDS(copula_comparison_file)
split_by_setting <- copula_comparisons |> split(copula_comparisons$settings) 
settings_names <- copula_comparisons$settings |> unique()

#copula_comparisons <- copula_comparisons |> group_by(settings, study_id, test_question_id) |> summarise(likelihood=max(likelihood), cum_prob=max(cum_prob)) |> ungroup()
```
```{r}

nr_na <- copula_comparisons |> group_by(settings) |> summarise(nr_na = sum(is.na(likelihood)), 
  nr_total = n(), percentage_na = nr_na/nr_total)
nr_na |> arrange(desc(nr_na))
```

```{r}

copula_plot_likelihood_boxplots <- function(df) {
  ggplot(df, aes(x=settings, y=likelihood)) +
    geom_boxplot() + # add line at y=1 
    #geom_violin(scale="area") + # add line at y=1 
    geom_hline(yintercept=1, linetype="dashed", color = "red") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  
}

copula_comparisons |> filter(likelihood<5)  |> copula_plot_likelihood_boxplots()
```

```{r}
# Looking at the times where eta10 ct0.5 did converge numerically
# remove test_question_id and study_id if there is any non finate value in that group
filtered<-copula_comparisons |> group_by(study_id, test_question_id) |> filter(all(is.finite(likelihood)))
filtered
```

```{r}
# function to create table of summary statistics for each setting
create_copula_summary_table <- function(df) {
  #df |> group_by(study_id, test_question_id) |> mutate(lower_than_indep = likeli)
  df  |> group_by(settings) |> summarise(
    num_higher=sum(likelihood>1),
    num_lower=sum(likelihood<1),
    num_equal=sum(likelihood==1),
    percentage_higher=num_higher/n(),
    percentage_lower=num_lower/n(),
    percentage_equal=num_equal/n(),
    mean_likelihoods=mean(likelihood),
    median_likelihoods=median(likelihood),
    sd_likelihoods=sd(likelihood),
    min_likelihoods=min(likelihood),
    max_likelihoods=max(likelihood),
  )
}

filtered |>  create_copula_summary_table() |> 
  arrange(percentage_lower - percentage_higher)
```
```{r}
copula_comparisons |> filter(is.finite(likelihood)) |>create_copula_summary_table()
```
